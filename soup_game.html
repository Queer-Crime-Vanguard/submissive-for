<!doctype html>

<html>
<head>
  <meta charset="utf-8">

  <title>HandsOff Example</title>
  <meta name="description" content="HandsOff game page">
  <meta name="author" content="HandsOff">
</head>

<body onload="setTrack()">
  
  <link rel="stylesheet" href="styles.css">
  <script type="text/javascript" src="js/sprite.js"></script>
  <script type="text/javascript" src="js/track.js"></script>

  <style>
    body {
        margin: 0;
    }
    
    .background {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: -2;
        background-image: url(assets/minigames/soup/bg.png);
        background-size: auto;
    }

    .blackout {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: -1;
        background-color: rgba(0, 0, 100, 0.25);
    }

  </style>

  <div class="background"></div>
  <div class="blackout"></div>

  <script src="https://unpkg.com/perlin-noise-3d"></script>

  <script>

    // small method for choosing random element of array
    Array.prototype.sample = function(){
        return this[Math.floor(Math.random()*this.length)];
    }


    let game_canvas = document.createElement('canvas');
    game_canvas.classList.add("minigame");

    let context = game_canvas.getContext('2d');

    let alph_tiles_img = new Image();
    alph_tiles_img.src = "assets/minigames/soup/alphabet.png";

    let fly_sprite = new Image();
    fly_sprite.src = "assets/minigames/soup/fly.png";

    const total_alph = 32;

    const alph_width = 50;
    const alph_height = 67;

    const offset_x = 30;
    const offset_y = 30;

    const wallRepulsionSoften = 0.7;

    const baseVelocity = 35;
    const initialAmplitude = 4;
    const smoothDec = (velocity) => {
        let k = 0.02;
        let dv = Math.max(velocity-baseVelocity, 0);
        return (dv*k)*(dv*k);
    }

    const spoonRepulsion = 5;

    const spoonRadialSpeed = 0.3;

    // words utilites
    
    const alphabet = 'абвгдежзийклмнопрстуфхцчшщъыьэюя';

    const goodWords = ['забота', 'отдых', 'сон']
    const badWords  = ['кусь']

    // UI

    let goodWord;
    let badWord;
    let found_letters;
    
    let main = () => {
        // choose words
        goodWord = goodWords.sample();
        badWord  = badWords.sample();
        found_letters = [];

        // generate letters

        let letters = new Array();

        let total_letters = goodWord.length + 20;

        let spiral = Math.min(width, height)/2;
        const spiral_turns = 4;
        const start_offset = 25;

        let generate_letter = (char, n) => {
            let i = alphabet.indexOf(char);
            let sprite = new Sprite(alph_tiles_img, 11, 3, total_alph);
            sprite.setFrame(i);

            // spiral positioning
            let r = spiral*((n+start_offset)/(total_letters+start_offset));
            let d = (n/total_letters)*2*Math.PI*spiral_turns;
            let home_pos_x = width/2 + r*Math.cos(d);
            let home_pos_y = height/2 + r*Math.sin(d);
            
            letters.push({
                char,
                sprite,
                home_pos_x,
                home_pos_y,
                'pos_x': home_pos_x,
                'pos_y': home_pos_y,
                'deg_offset': Math.random()*2*Math.PI,
                noise : new perlinNoise3d(),
                'display': 'normal'
            })
        }

        n = 0;
        for (c of goodWord) {
            generate_letter(c, n)
            n += 1;
        }

        // junk

        let remaining_letters = [];

        for (c of alphabet) {
            if (!goodWord.includes(c)) {remaining_letters.push(c)}
        }

        for (let t = 0; t < 20; t += 1) {
            generate_letter(remaining_letters.sample(), n)
            n += 1;
        }

        // interact with letter

        let interact = (letter) => {
            if (goodWord.includes(letter.char)) {
                found_letters.push(letter.char)
                letters.splice(letters.indexOf(letter), 1)
            }
        }

        const rad_amp = 50;
        const rad_freq = 0.1;

        const deg_velocity_amp = 0.2;
        const deg_velocity_freq = 0.1;

        const noisyMove = (totalTime) => {
            for (let letter of letters) {

                let rad = rad_amp*letter.noise.get(rad_freq*totalTime, 0);
                let deg_velocity = deg_velocity_amp*(letter.noise.get(0, deg_velocity_freq*totalTime)-0.5);

                letter.pos_x = letter.home_pos_x + rad*Math.cos(deg_velocity*totalTime + letter.deg_offset);
                letter.pos_y = letter.home_pos_y + rad*Math.sin(deg_velocity*totalTime + letter.deg_offset);
            }
        }

        const amp = 50;
        const freq = 0.2;

        const noisyMoveSimple = (totalTime) => {
            for (let letter of letters) {

                letter.pos_x = letter.home_pos_x + amp*(letter.noise.get(freq*totalTime, 0)-0.5);
                letter.pos_y = letter.home_pos_y + amp*(letter.noise.get(0, freq*totalTime)-0.5);
            }
        }

        const drawFrame = () => {
            context.clearRect(0, 0, width, height);
            for (let letter of letters) {
                switch (letter.display) {
                    case 'normal':
                        context.drawImage(letter.sprite.frame,
                                    letter.pos_x, 
                                    letter.pos_y, 
                                    alph_width,
                                    alph_height);
                        break
                    case 'fail':
                        context.drawImage(fly_sprite,
                                  letter.pos_x, 
                                  letter.pos_y, 
                                  alph_width,
                                  alph_height);
                        break
                }
                
            }
        }

        let prev_ts = null;
        
        const step = (ts) => {
            if (prev_ts) {
                delta = (ts - prev_ts)/1000;
            } else {
                delta = 0;
            }
            prev_ts = ts;
            // updatePhysics(delta);
            noisyMoveSimple(ts/1000);
            drawFrame();
            window.requestAnimationFrame(step);
        }

        window.requestAnimationFrame(step);
    }

    window.addEventListener("size_update", () => {
        game_canvas.width = width;
        game_canvas.height = height;
        alph_tiles_img.onload = main;
        if (alph_tiles_img.complete) {main();}
    })

    document.body.appendChild(game_canvas);

  </script>

</body>
</html>
